# Prime Send/Receive Go

Prime Send/Receive Go is a deposit and withdrawal management system with Coinbase Prime API integration, designed to work out of the box with Coinbase Prime's scalable deposit address solution.

## Overview

This system processes crypto deposits and withdrawals in real time by monitoring Prime API transactions and maintaining user balances in a high-performance subledger.

**Core Features:**
- Real-time deposit detection from Prime API
- Withdrawal confirmation tracking via idempotency keys
- Subledger with O(1) balance lookups
- Complete audit trail and transaction history
- Configurable via environment variables

## Setup

### 1. Environment Configuration

Copy and configure environment variables:
```bash
cp .env.example .env
```

**Required Environment Variables:**
```bash
# Prime API credentials (required)
PRIME_CREDENTIALS=/path/to/your/prime-credentials.json

# Database configuration (autogenerated, optional)
DATABASE_PATH=addresses.db

# Listener configuration (optional)
LISTENER_LOOKBACK_WINDOW=6h        # How far back to check for missed transactions
LISTENER_POLLING_INTERVAL=10s      # How often to poll Prime API
LISTENER_CLEANUP_INTERVAL=15m      # How often to clean up processed transaction cache
ASSETS_FILE=assets.yaml            # Asset configuration file
```

### 2. Asset Configuration

Create `assets.yaml` to specify which cryptocurrencies to monitor. You must specify the appropriate network, e.g. `ethereum-mainnet`. A full list of such networks is returned by the [List Assets](https://docs.cdp.coinbase.com/api-reference/prime-api/rest-api/assets/list-assets) REST API:
```yaml
assets:
  - symbol: "USDC"
    network: "ethereum-mainnet"
  - symbol: "BTC"
    network: "bitcoin-mainnet"
  - symbol: "ETH"
    network: "ethereum-mainnet"
  - symbol: "SOL"
    network: "solana-mainnet"
```

### 3. User Configuration (Production)

**For Production Use**: Edit `migrations/004_add_more_dummy_users.sql` to replace dummy users with your actual users:

```sql
-- Replace the dummy users with your production users
INSERT INTO users (name, email) VALUES 
    ('John Doe', 'john.doe@yourcompany.com'),
    ('Jane Smith', 'jane.smith@yourcompany.com'),
    ('Your Customer', 'customer@yourcompany.com');
```

### 4. Initial Setup

Generate deposit addresses for provided users:
```bash
go run cmd/main.go
```

This will:
- Initialize the database and run migrations (including user creation)
- Create Prime wallets for each asset
- Generate unique deposit addresses per user/asset
- Store addresses in the database

## Running the System

### Deposit & Withdrawal Listener

Start the real-time transaction listener:
```bash
go run cmd/listener/main.go
```

This service:
- Monitors all configured wallets for new transactions
- Processes deposits automatically when they reach "TRANSACTION_IMPORTED" status
- Processes withdrawals when they reach "TRANSACTION_DONE" status
- Updates user balances in real-time
- Handles out-of-order transactions with lookback window
- Prevents duplicate processing

## How the Ledger Works

### Balance Management
- **Current Balances**: Stored in `account_balances` table for O(1) lookups
- **Transaction History**: Complete audit trail in `transactions` table
- **Atomic Updates**: Balance and transaction record updated together
- **Optimistic Locking**: Prevents race conditions with version control

### Database Schema
```sql
-- Fast balance lookups
account_balances: user_id, asset, balance, version

-- Complete transaction history  
transactions: user_id, asset, type, amount, balance_before, balance_after, external_transaction_id

-- User and address management
users: id, name, email
addresses: user_id, asset, address, wallet_id
```

## Withdrawal Tracking

### Idempotency Key Format
When creating withdrawals via Prime API, use this UUID idempotency key format:
```
{user_id_prefix}-withdrawal-{timestamp}-{random}
```

**Example:**
```bash
# If user ID is: abc123-def4-567g-890h-ijklmnop1234
# Use idempotency key: abc123-dd20-466b-b4c1-d0290db08715
```

**Why This Works:**
The system matches withdrawals to users by comparing the first segment of the user ID with the first segment of the idempotency key. This is preferred over relying on a withdrawal trigger, as withdrawals can be rejected or fail.

### Withdrawal Processing Flow
1. **Create Withdrawal**: Submit to Prime API with proper idempotency key
2. **Transaction Appears**: Listener detects new withdrawal transaction
3. **Status Check**: Waits for "TRANSACTION_DONE" status
4. **User Matching**: Matches via idempotency key prefix
5. **Balance Update**: Debits user balance atomically
6. **Confirmation**: Logs successful processing

## Monitoring & Debugging

### Check User Balances
```sql
SELECT u.name, ab.asset, ab.balance 
FROM users u 
JOIN account_balances ab ON u.id = ab.user_id
WHERE ab.balance > 0;
```

### View Recent Transactions
```sql
SELECT u.name, t.transaction_type, t.asset, t.amount, t.created_at
FROM transactions t
JOIN users u ON t.user_id = u.id  
ORDER BY t.created_at DESC
LIMIT 10;
```

### Balance Reconciliation
```sql
SELECT 
  ab.user_id,
  ab.asset,
  ab.balance as current_balance,
  COALESCE(SUM(t.amount), 0) as calculated_balance
FROM account_balances ab
LEFT JOIN transactions t ON ab.user_id = t.user_id AND ab.asset = t.asset
GROUP BY ab.user_id, ab.asset;
```